/*!
 * This file is part of the BrickRouge package.
 *
 * (c) Olivier Laviale <olivier.laviale@gmail.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */
var BrickRouge={Utils:{Busy:new Class({startBusy:function(){if(++this.busyNest==1){return;
}this.element.addClass("busy");},finishBusy:function(){if(--this.busyNest){return;
}this.element.removeClass("busy");}})},updateAssets:(function(){var b=null,a=null;
return function(e,c){var d=new Array(),f=new Array(),g;if(b===null){b=new Array();
if(typeof(document_cached_css_assets)!=="undefined"){b=document_cached_css_assets;
}document.id(document.head).getElements('link[type="text/css"]').each(function(h){b.push(h.get("href"));
});}if(a===null){a=new Array();if(typeof(brickrouge_cached_js_assets)!=="undefined"){a=brickrouge_cached_js_assets;
}document.id(document.html).getElements("script").each(function(h){var i=h.get("src");
if(i){a.push(i);}});}e.css.each(function(h){if(b.indexOf(h)!=-1){return;}d.push(h);
});d.each(function(h){new Asset.css(h);b.push(h);});e.js.each(function(h){if(a.indexOf(h)!=-1){return;
}f.push(h);});g=f.length;if(!g){c();return;}f.each(function(h){new Asset.javascript(h,{onload:function(){a.push(h);
if(!--g){c();}}});});};})(),Widget:{},awakeWidgets:function(a){a=a||document.id(document.body);
Object.each(BrickRouge.Widget,(function(d,c){var b=".widget"+c.hyphenate();a.getElements(b).each(function(e){if(e.retrieve("widget")){return;
}var f=new d(e,e.get("dataset"));e.store("widget",f);});}));}};if(Request.API){Request.Element=new Class({Extends:Request.API,onSuccess:function(a,c){var b=Elements.from(a.rc).shift();
if(!a.assets){this.parent(b,a,c);return;}BrickRouge.updateAssets(a.assets,function(){this.fireEvent("complete",[a,c]).fireEvent("success",[b,a,c]).callChain();
}.bind(this));}});Request.Widget=new Class({Extends:Request.Element,initialize:function(a,c,b){if(b==undefined){b={};
}b.url="widgets/"+a;b.onSuccess=c;this.parent(b);}});}Element.Properties.widget={get:function(){var d=this.retrieve("widget"),c,a,b;
if(!d){c=this.className.match(/widget(-\S+)/);if(c&&c.length){a=c[1].camelCase();
b=BrickRouge.Widget[a];if(!b){throw'Constructor "'+b+'"is not defined to create widgets of type "'+c+'"';
}d=new b(this,this.get("dataset"));this.store("widget",d);}}return d;}};Element.Properties.dataset={get:function(){var d={},b=this.attributes,c,a;
for(c=0,y=b.length;c<y;c++){a=b[c];if(!a.name.match(/^data-/)){continue;}d[a.name.substring(5).camelCase()]=a.value;
}return d;}};document.addEvent("elementsready",function(a){BrickRouge.awakeWidgets(a.target);
});window.addEvent("domready",function(){document.fireEvent("elementsready",{target:document.id(document.body)});
});document.id(document.body).addEvent("click:relay(div.alert-message a.close)",function(b,c){b.stop();
var a=c.getParent("form");if(a){a.getElements(".error").removeClass("error");}c.getParent("div.alert-message").destroy();
});BrickRouge.Form=new Class({Implements:[Options,Events],options:{url:null,useXHR:false},initialize:function(b,a){this.element=document.id(b);
this.setOptions(a);if(this.options.useXHR||(a&&(a.onRequest||a.onComplete||a.onFailure||a.onSuccess))){this.element.addEvent("submit",function(c){c.stop();
this.submit();}.bind(this));}},alert:function(c,b){var a,d=this.element.getElement("div.alert-message."+b)||new Element("div.alert-message."+b,{html:'<a href="#close" class="close">Ã—</a>'});
if(typeOf(c)=="string"){c=[c];}else{if(typeOf(c)=="object"){a=c;c=[];Object.each(a,function(h,l){if(typeOf(l)=="string"&&l!="_base"){var g,k,f=this.element.elements[l],e;
if(typeOf(f)=="collection"){g=f[0].getParent("div.radio-group");k=g.getParent(".field");
if(g){g.addClass("error");}else{for(e=0,j=f.length;e<j;e++){f[e].addClass("error");
}}}else{f.addClass("error");k=f.getParent(".field");}if(k){k.addClass("error");}}if(!h||h===true){return;
}c.push(h);},this);}}if(!c.length){return;}c.each(function(e){d.adopt(new Element("p",{html:e}));
});if(!d.parentNode){d.inject(this.element,"top");}},clearAlert:function(){var a=this.element.getElements("div.alert-message");
if(a){a.destroy();}this.element.getElements(".error").removeClass("error");},submit:function(){this.fireEvent("submit",{});
this.getOperation().send(this.element);},getOperation:function(){if(this.operation){return this.operation;
}return this.operation=new Request.JSON({url:this.options.url||this.element.action,onRequest:this.request.bind(this),onComplete:this.complete.bind(this),onSuccess:this.success.bind(this),onFailure:this.failure.bind(this)});
},request:function(){this.clearAlert();this.fireEvent("request",arguments);},complete:function(){this.fireEvent("complete",arguments);
},success:function(a){if(a.success){this.alert(a.success,"success");}this.onSuccess(a);
},onSuccess:function(a){this.fireEvent("complete",arguments).fireEvent("success",arguments).callChain();
},failure:function(b){var a=JSON.decode(b.responseText);if(a&&a.errors){this.alert(a.errors,"error");
}this.fireEvent("failure",arguments);}});document.id(document.body).addEvent("click:relay(div.alert-message a.close)",function(b,c){b.stop();
var a=c.getParent("form");if(a){a.getElements(".error").removeClass("error");}c.getParent("div.alert-message").destroy();
});BrickRouge.Popover=new Class({Implements:[Events,Options],options:{anchor:null,placement:null,visible:false,fitContent:false},initialize:function(b,a){this.element=$(b);
this.setOptions(a);this.arrow=this.element.getElement(".arrow");this.actions=this.element.getElement("div.actions");
this.repositionCallback=this.reposition.bind(this,false);this.quickRepositionCallback=this.reposition.bind(this,true);
this.iframe=null;if(this.options.anchor){this.attachAnchor(this.options.anchor);}this.tween=null;
if(this.options.animate){this.tween=new Fx.Tween(this.element,{property:"opacity",link:"cancel",duration:"short"});
}if(this.options.fitContent){this.element.addClass("fit-content");}this.element.addEvent("click",this.onClick.bind(this));
if(this.options.visible){this.show();}},attachAnchor:function(a){this.anchor=$(a);
if(!this.anchor){this.anchor=$(document.body).getElement(a);}},onClick:function(a){var b=a.target;
if(b.tagName=="BUTTON"&&b.getParent("div.actions")){this.fireAction({action:b.get("data-action"),popover:this,ev:a});
}},fireAction:function(a){this.fireEvent("action",arguments);},changePlacement:function(a){this.element.removeClass("before");
this.element.removeClass("after");this.element.removeClass("above");this.element.removeClass("below");
this.element.addClass(a);},show:function(){this.element.setStyles({display:"block",visibility:"hidden"});
window.addEvents({load:this.quickRepositionCallback,resize:this.quickRepositionCallback,scroll:this.repositionCallback});
if(this.iframe){$(this.iframe.contentWindow).addEvents({load:this.quickRepositionCallback,resize:this.quickRepositionCallback,scroll:this.repositionCallback});
}this.reposition(true);if(this.options.animate){this.tween.set(0);this.element.setStyle("visibility","visible");
this.tween.start(1);}else{this.element.setStyle("visibility","visible");}},hide:function(){window.removeEvent("load",this.quickRepositionCallback);
window.removeEvent("resize",this.quickRepositionCallback);window.removeEvent("scroll",this.repositionCallback);
if(this.iframe){var a=$(this.iframe.contentWindow);a.removeEvent("load",this.quickRepositionCallback);
a.removeEvent("resize",this.quickRepositionCallback);a.removeEvent("scroll",this.repositionCallback);
}if(this.options.animate){this.tween.start(0).chain(function(){this.element.setStyle("display","");
});}else{this.element.setStyle("display","");}},computeAnchorBox:function(){var f=this.anchor,h,d=this.iframe,b,a,g,i,e,c;
if(d){b=d.getCoordinates();a=d.contentDocument.documentElement;aX=f.offsetLeft;aY=f.offsetTop;
aW=f.offsetWidth;aH=f.offsetHeight;g=a.clientHeight;e=a.scrollTop;aY-=e;if(aY<0){aH+=aY;
}aY=Math.max(aY,0);aH=Math.min(aH,g);i=a.clientWidth;c=a.scrollLeft;aX-=c;if(aX<0){aW+=aX;
}aX=Math.max(aX,0);aW=Math.min(aW,i);aX+=b.left;aY+=b.top;}else{h=f.getCoordinates();
aX=h.left;aY=h.top;aH=h.height;aW=h.width;}return{x:aX,y:aY,w:aW,h:aH};},computeBestPlacement:function(n,o,k){var l=document.body.parentNode,c=l.scrollWidth,g=n.x,f=n.y,i=n.w,e,d=20;
function b(){return g+1>o+d*2;}function a(){return c-(g+1+i)>o+d*2;}function m(){return f+1>k+d*2;
}e=this.options.placement;switch(e){case"after":if(a()){return e;}break;case"before":if(b()){return e;
}break;case"above":if(m()){return e;}break;case"below":return e;}if(a()){return"after";
}if(b()){return"before";}if(m()){return"above";}return"below";},reposition:function(A){if(!this.anchor){return;
}if(A===undefined){A=this.element.getStyle("visibility")!="visible";}var C=20,k=this.actions,z,c,b,d,n,f,e,s=this.element.getSize(),l=s.x,B=s.y,i,g,p,m=document.id(document.body),E=m.getSize(),a=m.getScroll(),u=a.x,t=a.y,v=E.x,D=E.y,o={top:null,left:null},r,q;
z=this.computeAnchorBox();c=z.x;b=z.y;d=z.w;n=z.h;f=c+d/2-1;e=b+n/2-1;p=this.computeBestPlacement(z,l,B);
this.changePlacement(p);if(p=="before"||p=="after"){g=Math.round(b+(n-B)/2-1);i=(p=="before")?c-l+1:c+d-1;
i=i.limit(u+C-1,u+v-(l+C)-1);g=g.limit(t+C-1,t+D-(B+C)-1);}else{i=Math.round(c+(d-l)/2-1);
g=(p=="above")?b-B+1:b+n-1;i=i.limit(u+C-1,u+v-(l+C)-1);}if(B>C*2){if(p=="before"||p=="after"){q=(b+n/2-1)-g;
q=Math.min(B-(k?k.getSize().y:C)-10,q);q=Math.max(C,q);if(q+g-1!=e){g-=(g+q)-e;}o.top=q;
}else{r=((c+d/2-1)-i).limit(C,l-C);if(r+l-1!=f){i-=(i+r)-f;}o.left=r;}}if(A){this.element.setStyles({left:i,top:g});
this.arrow.setStyles(o);}else{this.element.morph({left:i,top:g});this.arrow.morph(o);
}}});BrickRouge.Popover.from=function(b){var d,f=b.title,c=b.content,e=b.actions,a=new Element("div.inner");
if(f){a.adopt(new Element("h3.title",{html:f}));}if(typeOf(c)=="element"){a.adopt(new Element("div.content").adopt(c));
}else{a.adopt(new Element("div.content",{html:c}));}if(e=="boolean"){e=[new Element('button.cancel[data-action="cancel"]',{html:"Cancel"}),new Element('button.primary[data-action="ok"]',{html:"Ok"})];
}if(e){a.adopt(new Element("div.actions").adopt(e));}d=new Element("div.popover").adopt([new Element("div.arrow"),a]);
return new BrickRouge.Popover(d,b);};BrickRouge.Widget.Popover=BrickRouge.Popover;
document.id(document.body).addEvents({'mouseenter:relay([rel="popover"])':function(b,d){var c,a;
c=d.retrieve("popover");if(!c){a=d.get("dataset");a.anchor=d;c=BrickRouge.Popover.from(a);
document.body.appendChild(c.element);d.store("popover",c);}c.show();},'mouseleave:relay([rel="popover"])':function(a,c){var b=c.retrieve("popover");
if(!b){return;}b.hide();}});BrickRouge.Widget.Searchbox=new Class({Implements:BrickRouge.Utils.Busy,initialize:function(b,a){this.element=document.id(b);
}});